<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í”„ë¼ì‹œì•„ í¬ë¦¬ì—ì´í„° ê°•ëª¨ì°Œì˜ ì‹œë®¬ë ˆì´í„° </title>
<style>
:root{
  --bg:#0b0f17; --card:#121a27; --text:#e8eefc;
  --muted:#9bb0d0; --line:#23324a; --danger:#ff4d4d;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;}
.wrap{max-width:1900px;margin:0 auto;padding:16px;}
.card{background:var(--card);border:1px solid var(--line);
  border-radius:14px;padding:14px;}
.top{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:flex-start;}
.kpi{font-size:18px;font-weight:900;}
.muted{color:var(--muted);font-size:13px;white-space:pre-wrap;}
button,input,textarea,select{
  background:#0f1624;color:var(--text);
  border:1px solid var(--line);border-radius:10px;padding:8px 12px;
}
button:hover{border-color:#3a527a;cursor:pointer;}
.btnLink{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  background:#0f1624;
  color:var(--text);
  border:1px solid var(--line);
  border-radius:10px;
  padding:8px 12px;
}
.btnLink:hover{
  border-color:#3a527a;
  cursor:pointer;
}
  
textarea{width:100%;height:280px;padding:10px;font-family:ui-monospace,Consolas,monospace;}
.grid{display:grid;grid-template-columns: 1fr 420px;gap:12px;}
.stage{position:relative;width:100%;height:2400px;border-radius:14px;
  overflow:hidden;background:#0a0f18;border:1px solid var(--line);}
canvas{width:100%;height:100%;display:block;}
.toolbar{position:absolute;top:12px;left:12px;display:flex;gap:8px;z-index:10;flex-wrap:wrap;align-items:center;}
.hint{position:absolute;bottom:10px;left:12px;font-size:12px;color:var(--muted);
  background:rgba(0,0,0,.45);padding:6px 8px;border-radius:10px;}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.hr{border-top:1px solid var(--line);margin:12px 0}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;
  border:1px solid var(--line);background:#0f1624;color:var(--muted);font-size:12px}
.small{font-size:12px}
.btnWide{width:100%}
/* ğŸ”’ SIM ì ê¹€(ë¹„ë²ˆ ì „) íë¦¼ ì²˜ë¦¬ */
.simLocked #cv {
  filter: blur(2px) brightness(0.75);
}
.simLocked .hint {
  opacity: 0.35;
}
 /* =========================
   âœ… ìƒë‹¨ ë©”ë‰´ ì •ë¦¬(ê·¸ë£¹/êµ¬ë¶„ì„ /í†¤)
   ========================= */
.topMenu{ gap:10px; }
.menuGroup{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

.divider{
  width:1px; height:28px;
  background: var(--line);
  opacity:.8;
  margin:0 4px;
}

/* ë²„íŠ¼ í†¤ 3ì¢… */
.btnPrimary{
  border-color: rgba(120,185,255,0.8);
}
.btnPrimary:hover{
  border-color: rgba(120,185,255,1);
}

.btnGhost{
  opacity: .92;
}

.btnDanger{
  border-color: rgba(255,77,77,0.55);
}
.btnDanger:hover{
  border-color: rgba(255,77,77,0.95);
}
/* âœ… ê´€ë¦¬ì ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
.adminBox{
  position:absolute;
  top:14px;
  right:14px;
  display:flex;
  gap:6px;
  align-items:center;
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#0f1624;
  opacity:.9;
}

.adminBox .title{
  font-size:12px;
  color:var(--muted);
  margin-right:4px;
}

  
 
/* ê³µìœ (ë·°ì–´) ëª¨ë“œì—ì„œ í¸ì§‘ UI ìˆ¨ê¹€ */
.viewerOnlyHide{display:none !important;}
</style>
</head>
<body>
<div class="wrap">
  <!-- âœ… ê´€ë¦¬ì ì „ìš© ì»¨íŠ¸ë¡¤ -->
<div class="adminBox">
  <span class="title">ê´€ë¦¬ì</span>
  <button id="toggleMode" class="btnGhost">ì‹œë®¬ë ˆì´í„° ë³´ê¸°</button>
  <button id="adminEdit" class="btnGhost">EDIT</button>
</div>


<div class="top">
  <div class="card" style="flex:1;min-width:780px">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="kpi">í”„ë¼ì‹œì•„ í¬ë¦¬ì—ì´í„° ê°•ëª¨ì°Œì˜ ì‹œë®¬ë ˆì´í„°</div>
        <div class="muted" id="subtitle">EDITì—ì„œ ë°°ê²½/ë…¸ë“œ/ë¼ì¸ ë°°ì¹˜ â†’ ë§í¬ ì €ì¥ â†’ ê³µìœ ìëŠ” SIMë§Œ</div>
      </div>
      <span class="badge" id="modeBadge">EDIT</span>
    </div>

    <div class="row" style="gap:18px;margin-top:10px">
      <div>
        <div class="muted">ì‹œì¦Œ ìµœëŒ€(ê³ ì •)</div>
        <div class="kpi" id="seasonMax">162</div>
      </div>

      <div>
        <div class="muted">í˜„ì¬ ë³´ìœ (ì…ë ¥)</div>
        <input id="ownedSp" type="number" min="0" max="162" value="145" style="width:140px">
        <div class="muted small">0 ~ 162</div>
      </div>

      <div>
        <div class="muted">ì‚¬ìš© / ë‚¨ì€</div>
        <div class="kpi"><span id="used">0</span> / <span id="left">145</span></div>
        <div class="muted small">ë‚¨ì€ = ë³´ìœ  - ì‚¬ìš©</div>
      </div>

      <div id="status" class="muted"></div>
    </div>
  </div>

  <div class="card" style="min-width:420px">
    <div class="row topMenu" style="justify-content:flex-end; flex-wrap:wrap;">

  <div class="menuGroup">
    <a class="btnLink" href="https://creators.nexon.com/kr/s/pramochi%238535" target="_blank" rel="noopener noreferrer">ê°•ëª¨ì°Œí›„ì›ë“±ë¡</a>
    <a class="btnLink" href="./board.html" target="_blank" rel="noopener noreferrer">ê²Œì‹œíŒ</a>
  </div>

  <div class="divider"></div>

  <div class="menuGroup">

  </div>

  <div class="divider"></div>

  <div class="menuGroup">
    <button id="saveLinkBase" class="btnGhost">ë§í¬ ì €ì¥(ì´ˆê¸°í™”)</button>
    <button id="saveLinkBuild" class="btnPrimary">ë§í¬ ì €ì¥(ë‚´ ë¹Œë“œ)</button>
    <button id="postBoard" class="btnPrimary">ê²Œì‹œíŒì— ê³µìœ </button>
  </div>

  <div class="divider"></div>

  <div class="menuGroup">
    <button id="resetPoints" class="btnDanger">í¬ì¸íŠ¸ ì´ˆê¸°í™”</button>
    <button id="retrySimPwd" class="btnGhost" style="display:none">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</button>
  </div>

</div>


    <div class="muted small" id="shareInfo" style="margin-top:6px"></div>
  </div>
</div>

<div class="grid" id="gridRoot">

  <div class="card">
    <div class="stage" id="stage">
      <div class="toolbar">
        <input id="bgUrlInput" class="editUI" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸° (ê³µìœ ìš©)" style="width:320px">
        <input id="bgFile" class="editUI" type="file" accept="image/*">

        <button id="zoomIn">+</button>
        <button id="zoomOut">-</button>
        <button id="resetView">ë·° ë¦¬ì…‹</button>

        <button id="clearAll" class="editUI">ë…¸ë“œ/ë¼ì¸ ì „ì²´ì‚­ì œ</button>

        <div class="editUI" style="padding:6px 10px;border:1px solid var(--line);border-radius:10px;min-width:240px">
          <div class="muted">ì„ íƒ ë…¸ë“œ í¬ê¸°: <b id="nodeSizeLabel">22</b></div>
          <input id="nodeSize" type="range" min="14" max="60" value="22" style="width:220px">
        </div>

        <div style="padding:6px 10px;border:1px solid var(--line);border-radius:10px;min-width:260px">
          <div class="muted">ì „ì²´ ìˆ«ì í¬ê¸°: <b id="labelSizeLabel">18</b></div>
          <input id="labelSize" type="range" min="10" max="34" value="18" style="width:240px">
        </div>

        <span class="badge">íœ : í™•ëŒ€/ì¶•ì†Œ Â· ë¹ˆê³³ ë“œë˜ê·¸: í™”ë©´ì´ë™</span>
      </div>

      <canvas id="cv"></canvas>

      <div class="hint" id="hint">
        EDIT: ë¹ˆê³³ í´ë¦­=ë…¸ë“œì¶”ê°€ / ë…¸ë“œ ë“œë˜ê·¸=ì´ë™ / ë¹ˆê³³ ë“œë˜ê·¸=í™”ë©´ì´ë™<br>
        SIM: ë…¸ë“œ ì¢Œí´ë¦­ +1 / ìš°í´ë¦­ -1 / ë¹ˆê³³ ë“œë˜ê·¸=í™”ë©´ì´ë™<br>
        ë¹¨ê°„ ë¼ì¸: ì„ í–‰(ë¶€ëª¨) ë¯¸ì¶©ì¡± ë˜ëŠ” íƒ1 ë¼ì¸ì´ ì´ë¯¸ ì„ íƒë¨<br>
        í˜•ê´‘ ìˆ«ì: ë…¸ë“œê°€ ìµœëŒ€ì¹˜ ë‹¬ì„±(ì˜ˆ: 1/1, 5/5)
      </div>
    </div>
  </div>

  <div class="card editUI" id="rightPanel">
    <div class="kpi" style="margin-bottom:6px">ì„ íƒí•œ ë…¸ë“œ</div>
    <div class="muted" id="selText">ì—†ìŒ</div>

    <div class="hr"></div>

    <div class="muted">ë…¸ë“œ ID</div>
    <input id="nodeId" placeholder="ì˜ˆ: N001">

    <div class="muted" style="margin-top:8px">ìµœëŒ€(1/1ì˜ ë’¤ ìˆ«ì)</div>
    <input id="nodeMax" type="number" min="1" value="1">

    <div class="muted" style="margin-top:8px">ì„ í–‰ì¡°ê±´ ëª¨ë“œ</div>
    <select id="prereqMode" style="width:100%">
      <option value="ALL">ALL (ë¶€ëª¨ ì „ë¶€ max í•„ìš”)</option>
      <option value="ANY">ANY (ë¶€ëª¨ ì¤‘ í•˜ë‚˜ë§Œ maxë©´ OK)</option>
    </select>
    <div class="muted small">â€» ì´ ì„¤ì •ì€ â€˜ì„ íƒí•œ ë…¸ë“œâ€™ê°€ ë¶€ëª¨ë¥¼ ê°€ì§ˆ ë•Œë§Œ ì˜ë¯¸ê°€ ìˆì–´.</div>

    <div class="row" style="margin-top:10px">
      <button id="applyNode" class="btnWide">ë…¸ë“œ ì •ë³´ ì ìš©</button>
      <button id="delNode" class="btnWide">ë…¸ë“œ ì‚­ì œ</button>
    </div>

    <div class="hr"></div>

    <div class="kpi" style="font-size:16px">ë¼ì¸ ì—°ê²° (ë‹¤ì¤‘ ë¶€ëª¨/ìì‹ ì§€ì›)</div>
    <div class="muted small" style="margin:6px 0">
      - ë…¸ë“œ í´ë¦­ í›„ â€œë¶€ëª¨ë¡œ ì§€ì •/ìì‹ìœ¼ë¡œ ì§€ì •â€ì„ ëˆŒëŸ¬ ëª©ë¡ì— ì¶”ê°€(í† ê¸€)<br>
      - â€œì—°ê²° ì¶”ê°€/ì œê±°â€ëŠ” ë¶€ëª¨ëª©ë¡Ã—ìì‹ëª©ë¡ ì „ì²´ì— ì ìš©
    </div>

    <div class="row">
      <button id="setParent" class="btnWide">ë¶€ëª¨ë¡œ ì§€ì •(í† ê¸€)</button>
      <button id="setChild" class="btnWide">ìì‹ìœ¼ë¡œ ì§€ì •(í† ê¸€)</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="addEdge" class="btnWide">ì—°ê²° ì¶”ê°€</button>
      <button id="removeEdge" class="btnWide">ì—°ê²° ì œê±°</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="clearParent" class="btnWide">ë¶€ëª¨ ëª©ë¡ ë¹„ìš°ê¸°</button>
      <button id="clearChild" class="btnWide">ìì‹ ëª©ë¡ ë¹„ìš°ê¸°</button>
    </div>

    <!-- âœ… ë°°íƒ€(íƒ1) ì„¤ì • -->
    <div class="row" style="margin-top:8px">
      <button id="setExclusive" class="btnWide">ë¶€ëª¨Ã—ìì‹ = íƒ1(ë°°íƒ€)ë¡œ ì„¤ì •</button>
      <button id="clearExclusive" class="btnWide">ë°°íƒ€(íƒ1) ì „ë¶€ ì‚­ì œ</button>
    </div>

    <div class="muted small" id="pcInfo" style="margin-top:8px"></div>
    <div class="muted small" id="exInfo" style="margin-top:6px"></div>

    <div class="hr"></div>

    <div class="kpi" style="font-size:16px">ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°</div>
    <div class="muted small">ì™„ë£Œë˜ë©´ JSONì„ ë³µì‚¬í•´ë„ ë˜ê³ , ë§í¬ ì €ì¥ìœ¼ë¡œ ê³µìœ í•´ë„ ë¨</div>

    <textarea id="json" spellcheck="false"></textarea>

    <div class="row" style="margin-top:8px">
      <button id="copyJson" class="btnWide">JSON ë³µì‚¬</button>
      <button id="loadJson" class="btnWide">JSON ë¶ˆëŸ¬ì˜¤ê¸°(ë¶™ì—¬ë„£ê¸°)</button>
    </div>
  </div>

</div>
</div>
<!-- =========================
     âœ… ê²Œì‹œíŒ ë“±ë¡ ëª¨ë‹¬ UI (prompt ëŒ€ì²´)
     ========================= -->
<div id="boardModalBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;">
  <div id="boardModal" style="max-width:520px; margin:8vh auto; background:#121a27; border:1px solid #23324a; border-radius:16px; padding:14px;">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="kpi" style="font-size:16px">ê²Œì‹œíŒì— ê³µìœ </div>
      <button id="bmClose" style="padding:6px 10px">âœ•</button>
    </div>

    <div class="muted small" style="margin-top:6px">
      ë‹‰ë„¤ì„/ì œëª©/ì§ì—…ì„ í•œ ë²ˆì— ì…ë ¥í•˜ê³  ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.
    </div>

    <div class="hr"></div>

    <div class="muted">ë‹‰ë„¤ì„</div>
    <input id="bmNickname" placeholder="ì˜ˆ) ê°•ëª¨ì°Œ" maxlength="20" style="width:100%">

    <div class="muted" style="margin-top:10px">ì œëª©</div>
    <input id="bmTitle" placeholder="ì˜ˆ) PVPìš© / ì‚¬ëƒ¥ìš©" maxlength="40" style="width:100%">

    <div class="muted" style="margin-top:10px">ì§ì—…</div>
    <select id="bmJobSelect" style="width:100%">
      <option value="">ì„ íƒí•´ì¤˜</option>
      <option value="ì‹¬ì—°ì¶”ë°©ì">ì‹¬ì—°ì¶”ë°©ì</option>
      <option value="íƒœì–‘ê°ì‹œì">íƒœì–‘ê°ì‹œì</option>
      <option value="í–¥ì‚¬ìˆ˜">í–¥ì‚¬ìˆ˜</option>
      <option value="í™˜ì˜ê²€ì‚¬">í™˜ì˜ê²€ì‚¬</option>
      <option value="ì§‘í–‰ê´€">ì§‘í–‰ê´€</option>
      <option value="ì£¼ë¬¸ê°ì¸ì‚¬">ì£¼ë¬¸ê°ì¸ì‚¬</option>
    </select>

    <div class="muted" style="margin-top:10px">í•œì¤„ ì„¤ëª…(ì„ íƒ)</div>
    <textarea id="bmDesc" style="height:110px" placeholder="ì˜ˆ) ë³´ìœ  145P ê¸°ì¤€, ë¶„ê¸° A ì„ íƒ ë¹Œë“œ"></textarea>

    <div class="row" style="justify-content:space-between; margin-top:10px">
      <div class="muted small" id="bmState"></div>
      <div class="row">
        <button id="bmCancel">ì·¨ì†Œ</button>
        <button id="bmSubmit">ë“±ë¡</button>
      </div>
    </div>
  </div>
</div>
<!-- =========================
     âœ… SIM ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬
     ========================= -->
<div id="simPwdBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:10000;">
  <div id="simPwdModal" style="max-width:420px; margin:12vh auto; background:#121a27; border:1px solid #23324a; border-radius:16px; padding:14px;">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="kpi" style="font-size:16px">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</div>
      <button id="simPwdClose" style="padding:6px 10px">âœ•</button>
    </div>

    <div class="muted small" style="margin-top:8px">
      ê°•ëª¨ì°Œ í›„ì›ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ì ê¸ˆì´ í•´ì œë©ë‹ˆë‹¤.
    </div>

    <div class="hr"></div>

    <div class="muted">ë¹„ë°€ë²ˆí˜¸</div>
    <input id="simPwdInput" type="password" placeholder="ì˜ˆ) pramochi#8535" style="width:100%">

    <div class="row" style="justify-content:space-between; margin-top:12px">
      <div class="muted small" id="simPwdState"></div>
      <div class="row">
        <button id="simPwdCancel">ì·¨ì†Œ</button>
        <button id="simPwdSubmit" class="btnPrimary">í™•ì¸</button>
      </div>
    </div>
  </div>
</div>

  

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://unpkg.com/lz-string@1.4.4/libs/lz-string.min.js"></script>
<script>

/** =========================
 *  âœ… Supabase ì„¤ì • (ì—¬ê¸°ë§Œ ë„¤ ê°’ìœ¼ë¡œ ë°”ê¾¸ê¸°)
 *  ========================= */
const SUPABASE_URL = "https://ytzggylozlcgcaoaupwo.supabase.co";       // Settings â†’ Data API â†’ Project URL
const SUPABASE_ANON_KEY = "sb_publishable_rZtoLYXkC53jwHycEzC2ZQ_RW82bspa"; // Settings â†’ API Keys â†’ Publishable key

// âœ… Supabase UMD ì „ì—­ì€ ë³´í†µ window.supabase í•˜ë‚˜ë§Œ ì¡ìœ¼ë©´ ë¨
const SB = window.supabase;

if (!SB || typeof SB.createClient !== "function") {
  alert("Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨(ì°¨ë‹¨/ì˜¤í”„ë¼ì¸). Ctrl+F5 í•´ë³´ê³ , ê·¸ë˜ë„ ì•ˆë˜ë©´ ì• ë“œë¸”ë¡/ë³´ì•ˆí”„ë¡œê·¸ë¨ í™•ì¸!");
  throw new Error("Supabase SDK not loaded");
}

// âœ… ì „ì—­ì— 'í´ë¼ì´ì–¸íŠ¸'ë¥¼ í•œ ë²ˆë§Œ ë§Œë“¤ê³  ì¬ì‚¬ìš©
window.__SB_CLIENT__ = window.__SB_CLIENT__ || SB.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// âœ… ì•ìœ¼ë¡œëŠ” ì´ ì´ë¦„ë§Œ ì‚¬ìš©
const sbClient = window.__SB_CLIENT__;

// âœ… ë°©ì–´ ì½”ë“œ
if (!sbClient || typeof sbClient.from !== "function") {
  console.log("SB =", SB);
  console.log("sbClient =", sbClient);
  throw new Error("Supabase client is invalid: sbClient.from is not a function");
}






// ì§§ì€ ID ìƒì„± (8~10ìë¦¬)
function makeId(len = 10){
  const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
  let out = "";
  for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
  return out;
}

// ì €ì¥: payload(json)ë¥¼ DBì— ì €ì¥í•˜ê³  id ë°˜í™˜
async function saveToDB(payloadObj){
  const id = makeId(10);

  const { error } = await sbClient
  .from("shares")
  .insert([{ id, payload: payloadObj }]);


  if(error) throw error;
  return id;
}

// ë¶ˆëŸ¬ì˜¤ê¸°: idë¡œ payload ê°€ì ¸ì˜¤ê¸°
async function loadFromDB(id){
  const { data, error } = await sbClient
  .from("shares")
  .select("payload")
  .eq("id", id)
  .single();

  if(error) throw error;
  return data.payload;
}

  
/** =========================
 *  âœ… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
 *  ========================= */
const ADMIN_PASSWORD = "dkgus12";
// âœ… SIM(ê³µìœ ) ë¹„ë°€ë²ˆí˜¸
const SIM_PASSWORD = "pramochi#8535";

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const stage = document.getElementById("stage");

const state = {
  seasonMax: 162,
  mode: "EDIT",
  owned: 145,
  nodes: [],
  edges: [],
  lvl: {},
  selected: null,

  parents: [],
  children: [],
  exclusives: [],

  bg: null,
  bgUrl: null,

  scale: 1,
  tx: 0,
  ty: 0,

  draggingNode: false,
  dragNode: null,
  dragOff: {x:0,y:0},

  panning: false,
  panStart: {sx:0, sy:0, tx:0, ty:0},

  pendingAdd: null,

  labelFontSize: 18,

  viewerMode: false,
  adminUnlocked: false,

  // ğŸ”’ SIM ì ê¸ˆ ìƒíƒœ
  simLocked: false,
  simUnlockedOnce: false,
};

const els = {
  subtitle: document.getElementById("subtitle"),
  modeBadge: document.getElementById("modeBadge"),
  ownedSp: document.getElementById("ownedSp"),
  used: document.getElementById("used"),
  left: document.getElementById("left"),
  status: document.getElementById("status"),
  toggleMode: document.getElementById("toggleMode"),
  adminEdit: document.getElementById("adminEdit"),
  resetPoints: document.getElementById("resetPoints"),
  saveLinkBase: document.getElementById("saveLinkBase"),
  saveLinkBuild: document.getElementById("saveLinkBuild"),
  shareInfo: document.getElementById("shareInfo"),
  retrySimPwd: document.getElementById("retrySimPwd"),
  bgUrlInput: document.getElementById("bgUrlInput"),
  bgFile: document.getElementById("bgFile"),
  zoomIn: document.getElementById("zoomIn"),
  zoomOut: document.getElementById("zoomOut"),
  resetView: document.getElementById("resetView"),
  clearAll: document.getElementById("clearAll"),
  nodeSize: document.getElementById("nodeSize"),
  nodeSizeLabel: document.getElementById("nodeSizeLabel"),
  labelSize: document.getElementById("labelSize"),
  labelSizeLabel: document.getElementById("labelSizeLabel"),
  selText: document.getElementById("selText"),
  nodeId: document.getElementById("nodeId"),
  nodeMax: document.getElementById("nodeMax"),
  applyNode: document.getElementById("applyNode"),
  delNode: document.getElementById("delNode"),
  setParent: document.getElementById("setParent"),
  setChild: document.getElementById("setChild"),
  addEdge: document.getElementById("addEdge"),
  removeEdge: document.getElementById("removeEdge"),
  clearParent: document.getElementById("clearParent"),
  clearChild: document.getElementById("clearChild"),
  pcInfo: document.getElementById("pcInfo"),
  setExclusive: document.getElementById("setExclusive"),
  clearExclusive: document.getElementById("clearExclusive"),
  exInfo: document.getElementById("exInfo"),
  json: document.getElementById("json"),
  copyJson: document.getElementById("copyJson"),
  loadJson: document.getElementById("loadJson"),
    postBoard: document.getElementById("postBoard"),
  prereqMode: document.getElementById("prereqMode"),
};

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function nextNodeId(){
  const used = new Set(state.nodes.map(n => n.id));
  let maxNum = 0;

  for(const id of used){
    const m = /^N(\d+)$/.exec(id);
    if(m) maxNum = Math.max(maxNum, parseInt(m[1], 10));
  }

  let n = maxNum + 1;
  while(used.has(`N${String(n).padStart(3,"0")}`)) n++;
  return `N${String(n).padStart(3,"0")}`;
}

function dedupeNodeIds(){
  const seen = new Set();

  for(const node of state.nodes){
    if(!node.id || typeof node.id !== "string"){
      node.id = nextNodeId();
    }
    if(seen.has(node.id)){
      const old = node.id;
      const neu = nextNodeId();
      node.id = neu;

      if(state.lvl && old in state.lvl){
        state.lvl[neu] = state.lvl[old];
        delete state.lvl[old];
      }else{
        state.lvl[neu] = 0;
      }

      state.edges = state.edges.map(([p,c])=>[
        p===old ? neu : p,
        c===old ? neu : c
      ]);

      state.exclusives = (state.exclusives||[]).map(g=>{
        const parent = (g.parent===old) ? neu : g.parent;
        const group = Array.isArray(g.group) ? g.group.map(x=> x===old ? neu : x) : [];
        return { parent, group };
      });
    }

    seen.add(node.id);
  }
}

// =========================
// âœ… ìˆ«ì ìº¡ìŠ(ë¼ë²¨) ê·¸ë¦¬ê¸° ìœ í‹¸
// =========================
function drawLabelCapsule(ctx, text, x, y, opt = {}){
  const padX = opt.padX ?? 10;
  if(opt.font) ctx.font = opt.font;
  const padY = opt.padY ?? 6;
  const r    = opt.r ?? 10;

  const bgA  = opt.bgA ?? 0.70;              // ë°°ê²½ íˆ¬ëª…ë„
  const fill = opt.fill ?? "#ffffff";        // ê¸€ììƒ‰
  const border = opt.border ?? "rgba(255,230,120,0.9)"; // í…Œë‘ë¦¬(ê¸ˆìƒ‰ ëŠë‚Œ)
  const borderW = opt.borderW ?? 2;

  const shadowBlur = opt.shadowBlur ?? 10;
  const shadowColor = opt.shadowColor ?? "rgba(255,210,90,0.35)";

  // í…ìŠ¤íŠ¸ í¬ê¸° ì¸¡ì •
  const m = ctx.measureText(text);
  const w = m.width + padX*2;
  const h = (opt.h ?? (state.labelFontSize + padY*2));

  const left = x - w/2;
  const top  = y - h/2;

  // ìº¡ìŠ(ë‘¥ê·¼ ì‚¬ê°í˜•) path
  ctx.save();
  ctx.beginPath();
  const rr = Math.min(r, h/2, w/2);
  ctx.moveTo(left + rr, top);
  ctx.arcTo(left + w, top, left + w, top + h, rr);
  ctx.arcTo(left + w, top + h, left, top + h, rr);
  ctx.arcTo(left, top + h, left, top, rr);
  ctx.arcTo(left, top, left + w, top, rr);
  ctx.closePath();

  // ë°°ê²½
  ctx.fillStyle = `rgba(0,0,0,${bgA})`;
  ctx.fill();

  // í…Œë‘ë¦¬ + ì€ì€í•œ ê¸€ë¡œìš°
  ctx.lineWidth = borderW;
  ctx.strokeStyle = border;
  ctx.shadowColor = shadowColor;
  ctx.shadowBlur = shadowBlur;
  ctx.stroke();

  // í…ìŠ¤íŠ¸
  ctx.shadowColor = "rgba(0,0,0,0.9)";
  ctx.shadowBlur = 6;
  ctx.fillStyle = fill;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(text, x, y);

  ctx.restore();
}

function setSimLocked(on){
  state.simLocked = on;

  // ìº”ë²„ìŠ¤ íë¦¼ í† ê¸€
  stage.classList.toggle("simLocked", on);

  // ì¬ì…ë ¥ ë²„íŠ¼ í‘œì‹œ
  if(els.retrySimPwd){
    els.retrySimPwd.style.display = (on && state.viewerMode) ? "inline-block" : "none";
  }

  // ìƒíƒœ ë¬¸êµ¬(ì—¬ê¸°ì„œ ì°ì–´ì£¼ê³ , updateTopì—ì„œ ì ê¹€ì´ë©´ ë®ì–´ì“°ì§€ ì•Šê²Œ ì²˜ë¦¬)
  if(on){
    els.status.textContent = "ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ë…¸ë“œ ì¡°ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í™”ë©´ ì´ë™/ì¤Œì€ ê°€ëŠ¥)  â†’ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ë²„íŠ¼";
    els.status.style.color = "#ff6b6b";
  }else{
    els.status.textContent = "âœ… ì ê¸ˆ í•´ì œë¨";
    els.status.style.color = "#9bb0d0";
  }
}

function askSimPassword(){
  openSimPwdModal();
}


function resize(){
  const r = stage.getBoundingClientRect();
  cv.width = r.width * devicePixelRatio;
  cv.height = r.height * devicePixelRatio;
  draw();
}
window.addEventListener("resize", resize);

function screenToWorld(sx, sy){
  return { x: (sx - state.tx) / state.scale, y: (sy - state.ty) / state.scale };
}

function getUsed(){
  return Object.values(state.lvl).reduce((a,b)=>a+b,0);
}

function updateTop(){
  const used = getUsed();
  els.used.textContent = used;
  els.left.textContent = state.owned - used;
  els.modeBadge.textContent = state.viewerMode ? "SIM(ê³µìœ )" : state.mode;
  els.toggleMode.textContent = state.viewerMode
  ? "ì‹œë®¬ë ˆì´í„° ë³´ê¸°"
  : ((state.mode === "SIM") ? "í¸ì§‘ê¸° ë³´ê¸°" : "ì‹œë®¬ë ˆì´í„° ë³´ê¸°");



  // âœ… í•µì‹¬: ì ê¹€ ìƒíƒœë©´ status ë¬¸êµ¬ë¥¼ updateTopì´ ë®ì–´ì“°ì§€ ì•Šê²Œ
  if(state.viewerMode && state.mode === "SIM" && state.simLocked){
    // used/left ë“±ì€ ê°±ì‹ í•˜ë˜, statusëŠ” setSimLockedì—ì„œ ì°ì€ ë¬¸êµ¬ ìœ ì§€
    return;
  }

  const ok = used <= state.owned;
  els.status.innerHTML = ok
    ? `âœ… ë³´ìœ  ${state.owned}P ì¤‘ ${used}P ì‚¬ìš©`
    : `âŒ ë³´ìœ  ${state.owned}P ì´ˆê³¼ ì‚¬ìš© (${used - state.owned}P)`;
  els.status.style.color = ok ? "#9bb0d0" : "#ff6b6b";
}

function updateRightPanel(){
  const n = state.nodes.find(x=>x.id===state.selected);
  els.selText.textContent = n ? n.id : "ì—†ìŒ";

  if(n){
    els.nodeId.value = n.id;
    els.nodeMax.value = n.max;
    if(els.prereqMode) els.prereqMode.value = n.prereqMode || "ALL";

    els.nodeSize.value = n.r;
    els.nodeSizeLabel.textContent = String(n.r);
  }else{
    els.nodeId.value = "";
    els.nodeMax.value = 1;
  }

  const pTxt = state.parents.length ? state.parents.join(", ") : "-";
  const cTxt = state.children.length ? state.children.join(", ") : "-";
  els.pcInfo.textContent = `ë¶€ëª¨ ëª©ë¡: ${pTxt}\nìì‹ ëª©ë¡: ${cTxt}`;

  if(els.exInfo){
    if(state.exclusives && state.exclusives.length){
      const lines = state.exclusives.map(g => `â€¢ ${g.parent} : [${(g.group||[]).join(", ")}]`);
      els.exInfo.textContent = `ë°°íƒ€(íƒ1) ê·¸ë£¹ ${state.exclusives.length}ê°œ\n` + lines.join("\n");
    }else{
      els.exInfo.textContent = "ë°°íƒ€(íƒ1) ê·¸ë£¹: ì—†ìŒ";
    }
  }
}

function pack({ includeLvl = true } = {}){
  const zeroLvl = Object.fromEntries(state.nodes.map(n => [n.id, 0]));

  return {
    seasonMax: state.seasonMax,
    owned: state.owned,
    nodes: state.nodes,
    edges: state.edges,
    lvl: includeLvl ? state.lvl : zeroLvl,
    view: { scale: state.scale, tx: state.tx, ty: state.ty },
    ui: { labelFontSize: state.labelFontSize },
    bgUrl: state.bgUrl,
    exclusives: state.exclusives,
  };
}

function syncJsonBox(){
  if(state.viewerMode) return;
  els.json.value = JSON.stringify(pack(), null, 2);
}

function applyPack(obj){
  state.owned = Number(obj.owned ?? state.owned);
  state.bgUrl = (typeof obj.bgUrl === "string") ? obj.bgUrl : null; // âœ… ì´ ì¤„ ì¶”ê°€
  state.nodes = Array.isArray(obj.nodes) ? obj.nodes : [];
  state.nodes.forEach(n=>{
    if(!n.prereqMode) n.prereqMode = "ALL";
    if(typeof n.r !== "number") n.r = 22;
  });

  state.edges = Array.isArray(obj.edges) ? obj.edges : [];
  state.lvl = (obj.lvl && typeof obj.lvl==="object") ? obj.lvl : {};
  state.exclusives = Array.isArray(obj.exclusives) ? obj.exclusives : [];
  
    // âœ… ì˜ˆì „ JSON í˜¸í™˜ìš© ê¸°ë³¸ê°’ ë³´ì •
  if(!obj.exclusives) state.exclusives = [];
  if(!obj.ui) obj.ui = { labelFontSize: 18 };

  if(obj.view){
    state.scale = Number(obj.view.scale ?? state.scale);
    state.tx = Number(obj.view.tx ?? state.tx);
    state.ty = Number(obj.view.ty ?? state.ty);
  }

  if(obj.ui && typeof obj.ui.labelFontSize === "number"){
    state.labelFontSize = clamp(obj.ui.labelFontSize, 10, 34);
    els.labelSize.value = String(state.labelFontSize);
    els.labelSizeLabel.textContent = String(state.labelFontSize);
  }

  if(typeof obj.bgUrl === "string" && obj.bgUrl.trim()){
    loadBgFromUrl(obj.bgUrl.trim(), false);
  }

  state.selected = null;
state.parents = [];
state.children = [];

// âœ… UI ì…ë ¥ê°’ë„ ê°™ì´ ê°±ì‹ 
els.ownedSp.value = String(state.owned);
if(!state.viewerMode) els.bgUrlInput.value = state.bgUrl || "";
  dedupeNodeIds(); // âœ… ë¡œë“œì‹œ ì¤‘ë³µ ID ìë™ ì •ë¦¬


}

function saveToHash({ includeLvl = false } = {}){
  const str = JSON.stringify(pack({ includeLvl }));
  const compressed = LZString.compressToEncodedURIComponent(str);
  location.hash = compressed;
}


function loadFromHash(){
  try{
    const h = location.hash.replace("#","");
    if(!h) return false;

    const str = LZString.decompressFromEncodedURIComponent(h);
    if(!str) return false;

    const obj = JSON.parse(str);
    applyPack(obj);
    return true;
  }catch(e){
    return false;
  }
}


function setViewerMode(on){
  state.viewerMode = on;

  document.querySelectorAll(".editUI").forEach(el=>{
    el.classList.toggle("viewerOnlyHide", on);
  });

  const grid = document.getElementById("gridRoot");
  grid.style.gridTemplateColumns = on ? "1fr" : "1fr 420px";

  if(on){
    els.subtitle.textContent = "ê³µìœ ìš© SIM í™”ë©´ (í¸ì§‘ ê¸°ëŠ¥ ìˆ¨ê¹€)";
    els.shareInfo.textContent = "ê³µìœ  ë§í¬ëŠ” SIM ì „ìš©ì…ë‹ˆë‹¤. (í¸ì§‘ì€ EDIT(ê´€ë¦¬ì) ë¹„ë²ˆ í•„ìš”)";
    state.mode = "SIM";
  }else{
    els.subtitle.textContent = "EDITì—ì„œ ë°°ê²½/ë…¸ë“œ/ë¼ì¸ ë°°ì¹˜ â†’ ë§í¬ ì €ì¥ â†’ ê³µìœ ìëŠ” SIMë§Œ";
    els.shareInfo.textContent = "";
  }
  if(els.postBoard) els.postBoard.style.display = on ? "inline-block" : "none";

  // âœ… ë ˆì´ì•„ì›ƒ ë°”ë€Œë©´ ìº”ë²„ìŠ¤ ì‹¤ì œ í”½ì…€ í¬ê¸°ë¶€í„° ë‹¤ì‹œ ë§ì¶°ì•¼ í´ë¦­ ì¢Œí‘œê°€ ì•ˆ í‹€ì–´ì§
  resize();   // (resize ì•ˆì—ì„œ draw() í˜¸ì¶œí•¨)
}

function loadBgFromUrl(url, alsoSetInput=true){
  if(!url) return;

  if(url.startsWith("blob:")){
    alert("âš ï¸ blob: ë¡œ ì‹œì‘í•˜ëŠ” URLì€ ë‚´ PCì—ì„œë§Œ ë³´ì´ê³  ê³µìœ ê°€ ë¶ˆê°€ëŠ¥í•´.\nì´ë¯¸ì§€ë¥¼ ì›¹ì— ì˜¬ë¦° ë’¤ https ì´ë¯¸ì§€ URLì„ ë„£ì–´ì¤˜.");
  }

  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = ()=>{
    state.bg = img;
    state.bgUrl = url;

    state.scale = stage.clientWidth / img.width;
    state.tx = 0;
    state.ty = 0;

    if(alsoSetInput && !state.viewerMode){
      els.bgUrlInput.value = url;
    }
    draw();
  };
  img.onerror = ()=>{
    alert("ë°°ê²½ ì´ë¯¸ì§€ URL ë¡œë“œ ì‹¤íŒ¨!\n- URLì´ ì§ì ‘ ì´ë¯¸ì§€(.png/.jpg)ë¡œ ì—´ë¦¬ëŠ”ì§€ í™•ì¸\n- ê¶Œí•œ ì œí•œ(ë¡œê·¸ì¸ í•„ìš”) URLì´ë©´ ì•ˆ ë¨");
  };
  img.src = url;
}

function isIn(arr, id){ return arr.indexOf(id) !== -1; }
function toggleIn(arr, id){
  const i = arr.indexOf(id);
  if(i === -1) arr.push(id);
  else arr.splice(i,1);
}

function parentsOf(childId){
  return state.edges.filter(([p,c])=>c===childId).map(([p])=>p);
}
function childrenOf(parentId){
  return state.edges.filter(([p,c])=>p===parentId).map(([_,c])=>c);
}
function descendantsOf(rootId){
  const seen = new Set();
  const q = [rootId];

  while(q.length){
    const cur = q.shift();
    const kids = childrenOf(cur);
    for(const k of kids){
      if(seen.has(k)) continue;
      seen.add(k);
      q.push(k);
    }
  }
  seen.delete(rootId);
  return [...seen];
}

function prereqOk(childId){
  const ps = parentsOf(childId);
  if(ps.length === 0) return true;

  const child = state.nodes.find(n=>n.id===childId);
  const mode = (child && child.prereqMode) ? child.prereqMode : "ALL";

  if(mode === "ANY"){
    for(const p of ps){
      const pn = state.nodes.find(n=>n.id===p);
      if(!pn) continue;
      const cur = state.lvl[p] || 0;
      if(cur >= pn.max) return true;
    }
    return false;
  }

  for(const p of ps){
    const pn = state.nodes.find(n=>n.id===p);
    if(!pn) continue;
    const cur = state.lvl[p] || 0;
    if(cur < pn.max) return false;
  }
  return true;
}

function getExclusiveGroup(parentId, childId){
  return state.exclusives.find(g => g && g.parent===parentId && Array.isArray(g.group) && g.group.includes(childId)) || null;
}
function otherChosenInGroup(groupObj, selfId){
  return (groupObj.group||[]).some(id => id !== selfId && (state.lvl[id] || 0) > 0);
}
function exclusiveOk(childId){
  const ps = parentsOf(childId);
  for(const p of ps){
    const g = getExclusiveGroup(p, childId);
    if(!g) continue;
    if(otherChosenInGroup(g, childId)) return false;
  }
  return true;
}

function canIncrease(childId){
  const n = state.nodes.find(x=>x.id===childId);
  if(!n) return { ok:false, msg:"ë…¸ë“œ ì—†ìŒ" };

  if(!prereqOk(childId)){
    const childNode = state.nodes.find(x=>x.id===childId);
    const mode = (childNode && childNode.prereqMode) ? childNode.prereqMode : "ALL";
    const hint = (mode === "ANY")
      ? "ì„ í–‰(ë¶€ëª¨) ì¡°ê±´ ë¯¸ì¶©ì¡± (ë¶€ëª¨ ì¤‘ 1ê°œ ì´ìƒ max í•„ìš”)"
      : "ì„ í–‰(ë¶€ëª¨) ì¡°ê±´ ë¯¸ì¶©ì¡± (ë¶€ëª¨ ì „ë¶€ max í•„ìš”)";
    return { ok:false, msg: hint };
  }

  if(!exclusiveOk(childId)) return { ok:false, msg:"ê°™ì€ ë¶„ê¸°(íƒ1) ë¼ì¸ì´ ì´ë¯¸ ì„ íƒë¨" };

  const cur = state.lvl[childId] || 0;
  if(cur >= n.max) return { ok:false, msg:"ì´ë¯¸ ìµœëŒ€" };
  if(getUsed() + 1 > state.owned) return { ok:false, msg:"ë³´ìœ  í¬ì¸íŠ¸ ë¶€ì¡±" };

  return { ok:true, msg:"OK" };
}

function canDecrease(nodeId){
  const n = state.nodes.find(x=>x.id===nodeId);
  if(!n) return { ok:false, msg:"ë…¸ë“œ ì—†ìŒ" };

  const cur = state.lvl[nodeId] || 0;
  if(cur <= 0) return { ok:false, msg:"ì´ë¯¸ 0" };

  const after = cur - 1;
  const breaksPrereq = (cur >= n.max) && (after < n.max);

  if(breaksPrereq){
    const desc = descendantsOf(nodeId);
    const blocked = desc.find(id => (state.lvl[id] || 0) > 0);
    if(blocked){
      return {
        ok:false,
        msg:`í•˜ìœ„ ë…¸ë“œ(${blocked})ê°€ ë‚¨ì•„ìˆì–´ì„œ\n${nodeId}ë¥¼ ì·¨ì†Œí•  ìˆ˜ ì—†ìŒ\nâ†’ ì•„ë˜(ìì‹/ì†ì)ë¶€í„° ë¨¼ì € 0ìœ¼ë¡œ ì·¨ì†Œí•´ì¤˜`
      };
    }
  }
  return { ok:true, msg:"OK" };
}

function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,cv.width,cv.height);

  ctx.setTransform(
    state.scale*devicePixelRatio,0,0,
    state.scale*devicePixelRatio,
    state.tx*devicePixelRatio,
    state.ty*devicePixelRatio
  );

  if(state.bg){
    ctx.globalAlpha = 1;
    ctx.drawImage(state.bg, 0, 0);
  }

  const lineAlpha = (state.mode === "SIM") ? 0.55 : 1;
  const nodeAlpha = (state.mode === "SIM") ? 0.45 : 1;

  state.edges.forEach(([p,c])=>{
    const pn = state.nodes.find(n=>n.id===p);
    const cn = state.nodes.find(n=>n.id===c);
    if(!pn||!cn) return;

    let ok = true;
    if(state.mode === "SIM"){
      const prereq = prereqOk(c);

      let excl = true;
      const g = getExclusiveGroup(p, c);
      if(g){
        excl = !otherChosenInGroup(g, c);
      }
      ok = prereq && excl;
    }

    ctx.globalAlpha = lineAlpha;
    ctx.strokeStyle = ok ? "rgba(120,185,255,0.95)" : "rgba(255,77,77,0.95)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(pn.x, pn.y);
    ctx.lineTo(cn.x, cn.y);
    ctx.stroke();
  });

  state.nodes.forEach(n=>{
    const cur = state.lvl[n.id] || 0;

    ctx.globalAlpha = nodeAlpha;
    ctx.beginPath();
    ctx.arc(n.x, n.y, n.r, 0, Math.PI*2);

    let fill = "#0c1220";
    if(state.mode === "EDIT" && !state.viewerMode){
      if(n.id === state.selected) fill = "#101a2e";
    }
    ctx.fillStyle = fill;
ctx.fill();

/* âœ… [ì¶”ê°€] ìµœëŒ€ì¹˜ë©´ ë…¸ë“œ ê²‰ í˜•ê´‘ ë§ */
const isMaxed = n.max > 0 && cur >= n.max;
if(isMaxed){
  ctx.save();
  ctx.globalAlpha = 1;
  ctx.beginPath();
  ctx.arc(n.x, n.y, n.r + 6, 0, Math.PI * 2);  // ë°”ê¹¥ ë§ í¬ê¸°(+6)
  ctx.strokeStyle = "#7CFF6B";                 // í˜•ê´‘ ì—°ë‘(ë„ˆ ìˆ«ììƒ‰ì´ë‘ ë™ì¼)
  ctx.lineWidth = 3;
  ctx.shadowColor = "rgba(124,255,107,0.95)";
  ctx.shadowBlur = 14;
  ctx.stroke();
  ctx.restore();
}

let stroke = "rgba(120,185,255,0.95)";
let lw = 2;


    if(state.mode === "EDIT" && !state.viewerMode){
      const sel = (n.id === state.selected);
      const isP = isIn(state.parents, n.id);
      const isC = isIn(state.children, n.id);

      if(isP) { stroke = "rgba(124,255,107,0.98)"; lw = 3; }
      if(isC) { stroke = "rgba(190,120,255,0.98)"; lw = 3; }
      if(sel) { stroke = "rgba(255,230,120,0.98)"; lw = 4; }
    }

    ctx.strokeStyle = stroke;
    ctx.lineWidth = lw;
    ctx.stroke();

    ctx.globalAlpha = 1;
    ctx.textAlign = "center";
const font = `900 ${state.labelFontSize}px sans-serif`;
ctx.font = font;

ctx.shadowColor = "transparent";
ctx.shadowBlur = 0;

const y = n.y + n.r + (state.labelFontSize + 0);
const text = `${cur}/${n.max}`;


// âœ… ìµœëŒ€ì¹˜ë©´ í˜•ê´‘ ê¸€ì ëŠë‚Œ(ê¸°ì¡´ ìœ ì§€) + ìº¡ìŠ í…Œë‘ë¦¬ë„ ë” ê°•ì¡°
if(isMaxed){
  drawLabelCapsule(ctx, text, n.x, y, {
  font,
  bgA: 0.75,
  fill: "#7CFF6B",
  border: "rgba(124,255,107,0.95)",
  borderW: 2,
  shadowColor: "rgba(124,255,107,0.35)",
  shadowBlur: 12,
  r: 10,
  padX: 12,
  padY: 6
});

}else{
  drawLabelCapsule(ctx, text, n.x, y, {
  font,
  bgA: 0.70,
  fill: "#ffffff",
  border: "rgba(255,230,120,0.85)",
  borderW: 2,
  shadowColor: "rgba(255,210,90,0.30)",
  shadowBlur: 10,
  r: 10,
  padX: 12,
  padY: 6
});
}


    ctx.shadowColor = "transparent";
    ctx.shadowBlur = 0;
  });

  updateTop();
  if(!state.viewerMode) updateRightPanel();
  syncJsonBox();
}

function hitNode(w){
  for(let i=state.nodes.length-1;i>=0;i--){
    const n = state.nodes[i];
    if(Math.hypot(n.x-w.x, n.y-w.y) < n.r + 6) return n;
  }
  return null;
}

function startPan(sx, sy){
  state.panning = true;
  state.panStart = { sx, sy, tx: state.tx, ty: state.ty };
}

function stopAllDrag(){
  state.draggingNode = false;
  state.dragNode = null;
  state.panning = false;
  state.pendingAdd = null;
}

cv.addEventListener("mousedown", (e)=>{
  const rect = cv.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;
  const w = screenToWorld(sx, sy);

  const node = hitNode(w);

  if(node){
    state.selected = node.id;

    if(state.mode === "EDIT" && !state.viewerMode){
      if(e.button === 0){
        state.draggingNode = true;
        state.dragNode = node;
        state.dragOff.x = w.x - node.x;
        state.dragOff.y = w.y - node.y;
      }
    }else{
      // âœ… ì ê¹€ì´ë©´: ìƒíƒœë¬¸êµ¬ + ëª¨ë‹¬ ìë™ì˜¤í”ˆ (ë” ì¹œì ˆ)
if(state.viewerMode && state.mode === "SIM" && state.simLocked){
  els.status.textContent = "ğŸ”’ ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. (í›„ì›ì½”ë“œ ì…ë ¥)";
  els.status.style.color = "#ff6b6b";
  draw();

  // â˜… ìë™ìœ¼ë¡œ ëª¨ë‹¬ ë„ìš°ê¸°
  askSimPassword();   // (promptê°€ ì•„ë‹ˆë¼ ëª¨ë‹¬ openSimPwdModal()ì´ ì—´ë¦¬ëŠ” ìƒíƒœì—¬ì•¼ í•¨)
  return;
}


      // SIM í¬ì¸íŠ¸ ì¡°ì‘ (+ ì„ í–‰ AND + ë°°íƒ€)
      if(e.button === 0){
        const check = canIncrease(node.id);
        if(check.ok){
          const cur = state.lvl[node.id] || 0;
          state.lvl[node.id] = cur + 1;
        }else{
          els.status.textContent = `âŒ ${check.msg}`;
          els.status.style.color = "#ff6b6b";
        }
      }
      if(e.button === 2){
        const check = canDecrease(node.id);
        if(check.ok){
          const cur = state.lvl[node.id] || 0;
          if(cur > 0) state.lvl[node.id] = cur - 1;
        }else{
          els.status.textContent = `âŒ ${check.msg}`;
          els.status.style.color = "#ff6b6b";
        }
      }
    }

    draw();
    return;
  }

  // âœ… ë¹ˆ ê³³ ì²˜ë¦¬
  if(e.button === 0){

    // âœ… ì•ˆì „ì¥ì¹˜: EDIT + (ë·°ì–´ì•„ë‹˜) + ì¢Œí´ë¦­ + "ì§„ì§œ ë¹ˆ ê³³"ì¼ ë•Œë§Œ ë…¸ë“œ ìƒì„± ì¤€ë¹„
    if(state.mode === "EDIT" && !state.viewerMode){
      if(!hitNode(w)){
        state.pendingAdd = { sx, sy, wx: w.x, wy: w.y };
      }else{
        state.pendingAdd = null;
      }
      return;
    }

    // SIM/ë·°ì–´ì—ì„œëŠ” ì¢Œí´ë¦­ ë¹ˆê³³ = í™”ë©´ì´ë™ ì‹œì‘
    startPan(sx, sy);
    return;
  }

  // ìš°í´ë¦­ì€ EDITì—ì„œ í™”ë©´ì´ë™
  if(state.mode === "EDIT" && e.button === 2){
    startPan(sx, sy);
    return;
  }
});



cv.addEventListener("mousemove",(e)=>{
  const rect = cv.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;

  if(state.draggingNode && state.dragNode){
    const w = screenToWorld(sx, sy);
    state.dragNode.x = w.x - state.dragOff.x;
    state.dragNode.y = w.y - state.dragOff.y;
    draw();
    return;
  }

  if(state.pendingAdd){
    const dx = sx - state.pendingAdd.sx;
    const dy = sy - state.pendingAdd.sy;
    const dist = Math.hypot(dx, dy);
    if(dist > 6){
      const startSx = state.pendingAdd.sx;
      const startSy = state.pendingAdd.sy;
      state.pendingAdd = null;
      startPan(startSx, startSy);
    }
  }

  if(state.panning){
    const dx = sx - state.panStart.sx;
    const dy = sy - state.panStart.sy;
    state.tx = state.panStart.tx + dx;
    state.ty = state.panStart.ty + dy;
    draw();
    return;
  }
});

cv.addEventListener("mouseup",(e)=>{
  if(state.pendingAdd){
    // í´ë¦­ìœ¼ë¡œ ë…¸ë“œ ì¶”ê°€
    const w = { x: state.pendingAdd.wx, y: state.pendingAdd.wy };
    state.pendingAdd = null;

    // âœ… ì•ˆì „ì¥ì¹˜: mouseup ì‹œì ì—ë„ "ë¹ˆ ê³³"ì¸ì§€ ì¬í™•ì¸
    // (ì¤Œ/ë“œë˜ê·¸ ì¤‘ ì¢Œí‘œ ì˜¤ì°¨ë‚˜ ê²½ê³„ì—ì„œ ì˜ëª» ìƒì„±ë˜ëŠ” ê±¸ ë°©ì§€)
    if(hitNode(w)){
      stopAllDrag();
      return;
    }

    if(state.mode === "EDIT" && !state.viewerMode){
      const id = nextNodeId(); // âœ… ì¤‘ë³µ ì—†ëŠ” ìƒˆ ID
      const newNode = {
        id,
        x: w.x,
        y: w.y,
        r: Number(els.nodeSize.value || 22),
        max: 1,
        prereqMode: "ALL",
      };
      state.nodes.push(newNode);
      state.lvl[id] = 0;
      state.selected = id;
      draw();
    }
  }

  stopAllDrag();
});


cv.addEventListener("mouseleave", ()=>{
  stopAllDrag();
});

cv.addEventListener("contextmenu",(e)=> e.preventDefault());

cv.addEventListener("wheel",(e)=>{
  e.preventDefault();

  const rect = cv.getBoundingClientRect();
  const sx = e.clientX - rect.left;
  const sy = e.clientY - rect.top;

  // ì¤Œ ì´ì „ ë§ˆìš°ìŠ¤ê°€ ê°€ë¦¬í‚¤ëŠ” ì›”ë“œì¢Œí‘œ
  const before = screenToWorld(sx, sy);

  // ìŠ¤ì¼€ì¼ ë³€ê²½
  const delta = -Math.sign(e.deltaY);
  const factor = (delta > 0) ? 1.08 : 1/1.08;
  const nextScale = clamp(state.scale * factor, 0.2, 3.0);
  state.scale = nextScale;

  // âœ… í•µì‹¬: "ë§ˆìš°ìŠ¤ ìœ„ì¹˜ê°€ ê°™ì€ ì›”ë“œì¢Œí‘œ"ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ tx/tyë¥¼ ì •ì„ìœ¼ë¡œ ì¬ê³„ì‚°
  state.tx = sx - before.x * state.scale;
  state.ty = sy - before.y * state.scale;

  draw();
},{ passive:false });


/** =========================
 *  UI ë²„íŠ¼/ì…ë ¥ ì´ë²¤íŠ¸
 *  ========================= */

// ë³´ìœ  í¬ì¸íŠ¸
els.ownedSp.addEventListener("input", ()=>{
  state.owned = clamp(Number(els.ownedSp.value || 0), 0, state.seasonMax);
  els.ownedSp.value = String(state.owned);
  draw();
});

// + / -
els.zoomIn.addEventListener("click", ()=>{
  state.scale = clamp(state.scale * 1.1, 0.2, 3.0);
  draw();
});
els.zoomOut.addEventListener("click", ()=>{
  state.scale = clamp(state.scale / 1.1, 0.2, 3.0);
  draw();
});
els.resetView.addEventListener("click", ()=>{
  state.scale = 1;
  state.tx = 0;
  state.ty = 0;
  draw();
});

// ë…¸ë“œ/ë¼ì¸ ì „ì²´ì‚­ì œ
els.clearAll.addEventListener("click", ()=>{
  if(!confirm("ë…¸ë“œ/ë¼ì¸ì„ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
  state.nodes = [];
  state.edges = [];
  state.exclusives = [];
  state.lvl = {};
  state.selected = null;
  state.parents = [];
  state.children = [];
  draw();
});

// ì„ íƒ ë…¸ë“œ í¬ê¸°
els.nodeSize.addEventListener("input", ()=>{
  els.nodeSizeLabel.textContent = String(els.nodeSize.value);
  const n = state.nodes.find(x=>x.id===state.selected);
  if(n){
    n.r = Number(els.nodeSize.value);
    draw();
  }
});

// ì „ì²´ ìˆ«ì í¬ê¸°
els.labelSize.addEventListener("input", ()=>{
  state.labelFontSize = clamp(Number(els.labelSize.value), 10, 34);
  els.labelSizeLabel.textContent = String(state.labelFontSize);
  draw();
});

// ë°°ê²½ URL ë¡œë“œ
els.bgUrlInput.addEventListener("change", ()=>{
  if(state.viewerMode) return;
  const url = String(els.bgUrlInput.value || "").trim();
  if(!url) return;

  // âœ… ì…ë ¥í•œ URLì„ ìƒíƒœì—ë„ í™•ì‹¤íˆ ì €ì¥
  state.bgUrl = url;

  // âœ… ë°°ê²½ ë¡œë“œ
  loadBgFromUrl(url, false);
});


// ë°°ê²½ íŒŒì¼ ì—…ë¡œë“œ(ë¡œì»¬) â†’ í¸ì§‘ ì¤‘ì—ë§Œ(ê³µìœ ëŠ” url í•„ìš”)
els.bgFile.addEventListener("change", (e)=>{
  if(state.viewerMode) return;
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  // ë¡œì»¬ì€ ê³µìœ  ë¶ˆê°€: ê²½ê³ ëŠ” loadBgFromUrlì—ì„œ ì²˜ë¦¬(ê·¼ë° blobì´ë©´ alert)
  loadBgFromUrl(url, true);
});

// í¬ì¸íŠ¸ ì´ˆê¸°í™”
els.resetPoints.addEventListener("click", ()=>{
  if(!confirm("í¬ì¸íŠ¸ë¥¼ ì „ë¶€ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œ?")) return;
  state.nodes.forEach(n=> state.lvl[n.id] = 0);
  draw();
});

// ë§í¬ ì €ì¥(ì´ˆê¸°í™”) = í…œí”Œë¦¿ ê³µìœ  (í¬ì¸íŠ¸ ìƒíƒœëŠ” 0ìœ¼ë¡œ)  âœ… DBì§§ì€ë§í¬
els.saveLinkBase.addEventListener("click", async ()=>{
  try{
    const payload = pack({ includeLvl: false }); // í¬ì¸íŠ¸ 0 í¬í•¨
    const id = await saveToDB(payload);

    const url = location.origin + location.pathname + "?id=" + id;

    await navigator.clipboard.writeText(url);
    els.shareInfo.textContent = "âœ… ì§§ì€ ë§í¬(ì´ˆê¸°í™”)ê°€ ë³µì‚¬ë¨";
  }catch(e){
    console.error(e);
    els.shareInfo.textContent = "âŒ ì§§ì€ ë§í¬ ì €ì¥ ì‹¤íŒ¨";
  }
  draw();
});


// ë§í¬ ì €ì¥(ë‚´ ë¹Œë“œ) = í˜„ì¬ ì°ì€ í¬ì¸íŠ¸ ìƒíƒœê¹Œì§€ í¬í•¨ âœ… DBì§§ì€ë§í¬
els.saveLinkBuild.addEventListener("click", async ()=>{
  try{
    const payload = pack({ includeLvl: true }); // í˜„ì¬ í¬ì¸íŠ¸ í¬í•¨
    const id = await saveToDB(payload);

    const url = location.origin + location.pathname + "?id=" + id;

    await navigator.clipboard.writeText(url);
    els.shareInfo.textContent = "âœ… ì§§ì€ ë§í¬(ë‚´ ë¹Œë“œ)ê°€ ë³µì‚¬ë¨";
  }catch(e){
    console.error(e);
    els.shareInfo.textContent = "âŒ ì§§ì€ ë§í¬ ì €ì¥ ì‹¤íŒ¨";
  }
  draw();
});
  // =========================
// âœ… ê²Œì‹œíŒì— ê³µìœ  (posts í…Œì´ë¸”ì— ì €ì¥)
// =========================
// =========================
// âœ… ê²Œì‹œíŒ ëª¨ë‹¬ í•¸ë“¤ëŸ¬ (prompt ëŒ€ì²´)
// =========================
const bm = {
  backdrop: document.getElementById("boardModalBackdrop"),
  modal: document.getElementById("boardModal"),
  close: document.getElementById("bmClose"),
  cancel: document.getElementById("bmCancel"),
  submit: document.getElementById("bmSubmit"),
  state: document.getElementById("bmState"),
  nickname: document.getElementById("bmNickname"),
  title: document.getElementById("bmTitle"),
  job: document.getElementById("bmJobSelect"),
  desc: document.getElementById("bmDesc"),
};
// =========================
// âœ… SIM ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ í•¸ë“¤ëŸ¬ (prompt ëŒ€ì²´)
// =========================
const spm = {
  backdrop: document.getElementById("simPwdBackdrop"),
  close: document.getElementById("simPwdClose"),
  cancel: document.getElementById("simPwdCancel"),
  submit: document.getElementById("simPwdSubmit"),
  input: document.getElementById("simPwdInput"),
  state: document.getElementById("simPwdState"),
};

function spmSetState(msg="", type=""){
  if(!spm.state) return;
  spm.state.textContent = msg;
  spm.state.style.color = (type === "err") ? "#ff6b6b" : "#9bb0d0";
}

function openSimPwdModal(){
  if(!spm.backdrop) return;
  spm.input.value = "";
  spmSetState("");
  spm.backdrop.style.display = "block";
  setTimeout(()=> spm.input.focus(), 0);
}

function closeSimPwdModal(){
  if(!spm.backdrop) return;
  spm.backdrop.style.display = "none";
}

function submitSimPwd(){
  const input = String(spm.input.value || "").trim();

  if(!input){
    spmSetState("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì¤˜.", "err");
    spm.input.focus();
    return;
  }

  if(input !== SIM_PASSWORD){
    spmSetState("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "err");
    setSimLocked(true);
    draw();
    spm.input.select();
    return;
  }

  // ì„±ê³µ
  spmSetState("âœ… ì ê¸ˆ í•´ì œ ì™„ë£Œ!", "");
  state.simUnlockedOnce = true;
  setSimLocked(false);
  draw();
  closeSimPwdModal();
}

// ì´ë²¤íŠ¸ ì—°ê²°
if(spm.backdrop && spm.close && spm.cancel && spm.submit && spm.input){
  spm.close.addEventListener("click", closeSimPwdModal);
  spm.cancel.addEventListener("click", closeSimPwdModal);
  spm.submit.addEventListener("click", submitSimPwd);

  spm.backdrop.addEventListener("mousedown", (e)=>{
    if(e.target === spm.backdrop) closeSimPwdModal();
  });

  spm.input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      submitSimPwd();
    }
    if(e.key === "Escape"){
      closeSimPwdModal();
    }
  });
}

function bmSetState(msg="", type=""){
  if(!bm.state) return;
  bm.state.textContent = msg;
  bm.state.style.color = (type === "err") ? "#ff6b6b" : "#9bb0d0";
}


function openBoardModal(){
  // âœ… EDITì—ì„œëŠ” ê¸ˆì§€
  if(!state.viewerMode){
    alert("âŒ í¸ì§‘(EDIT) ëª¨ë“œì—ì„œëŠ” ê²Œì‹œíŒ ë“±ë¡ì´ ë¶ˆê°€í•©ë‹ˆë‹¤. ê³µìœ (SIM) ë§í¬ë¡œ ë“¤ì–´ê°€ì„œ ë“±ë¡í•´ì£¼ì„¸ìš”.");
    return;
  }
  // âœ… ê³µìœ ëª¨ë“œë¼ë„ ë¹„ë²ˆ ì ê¸ˆì´ë©´ ê¸ˆì§€
  if(state.simLocked){
  bmSetState("ğŸ”’ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¨¼ì € ì…ë ¥í•´ì•¼ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”.", "err");
  askSimPassword(); // ìë™ìœ¼ë¡œ ë¹„ë²ˆ ëª¨ë‹¬ ì˜¤í”ˆ
  return;
}


  // ì…ë ¥ ì´ˆê¸°í™”(ì›í•˜ë©´ ë‹‰ë„¤ì„ë§Œ ìœ ì§€í•˜ë„ë¡ ë°”ê¿”ë„ ë¨)
  bm.nickname.value = "";
  bm.title.value = "";
  bm.job.value = "";
  bm.desc.value = "";
  bmSetState("");

  bm.backdrop.style.display = "block";
  bm.nickname.focus();
}

function closeBoardModal(){
  bm.backdrop.style.display = "none";
}

async function submitBoardPost(){
  const nickname = (bm.nickname.value || "").trim();
  const title = (bm.title.value || "").trim();
  const job = (bm.job.value || "").trim();
  const desc = (bm.desc.value || "").trim();

  if(!nickname){ bmSetState("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì¤˜.", "err"); bm.nickname.focus(); return; }
  if(!title){ bmSetState("ì œëª©ì„ ì…ë ¥í•´ì¤˜.", "err"); bm.title.focus(); return; }
  if(!job){ bmSetState("ì§ì—…ì„ ì„ íƒí•´ì¤˜.", "err"); bm.job.focus(); return; }

  try{
    bmSetState("ì €ì¥ ì¤‘...", "");

    // 1) í˜„ì¬ ë¹Œë“œ ì €ì¥ â†’ shares
    const payload = pack({ includeLvl: true });
    const shareId = await saveToDB(payload);

    // 2) posts ì €ì¥
    const { error } = await sbClient
      .from("posts")
      .insert([{
        nickname,
        title,
        job,
        sp: Number(state.owned || 0),
        desc,
        share_id: shareId
      }]);

    if(error) throw error;

    bmSetState("âœ… ë“±ë¡ ì™„ë£Œ!", "");
    alert("âœ… ê²Œì‹œíŒ ë“±ë¡ ì™„ë£Œ!\n(ê²Œì‹œíŒ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´)");
    closeBoardModal();
  }catch(e){
    console.error(e);
    bmSetState("âŒ ë“±ë¡ ì‹¤íŒ¨! (Supabase RLS/í…Œì´ë¸” ì„¤ì • í™•ì¸ í•„ìš”)", "err");
    alert("âŒ ê²Œì‹œíŒ ë“±ë¡ ì‹¤íŒ¨! (Supabase RLS/í…Œì´ë¸” ì„¤ì • í™•ì¸ í•„ìš”)");
  }
}


if(els.postBoard){
  els.postBoard.addEventListener("click", openBoardModal);
}

// ëª¨ë‹¬ ì´ë²¤íŠ¸(ì•ˆì „í•˜ê²Œ: ìš”ì†Œê°€ ìˆì„ ë•Œë§Œ ë“±ë¡)
if(bm.backdrop && bm.close && bm.cancel && bm.submit){
  // ëª¨ë‹¬ ë‹«ê¸° ë™ì‘
  bm.close.addEventListener("click", closeBoardModal);
  bm.cancel.addEventListener("click", closeBoardModal);

  // ë°”ê¹¥(ê²€ì€ ë°°ê²½) í´ë¦­í•˜ë©´ ë‹«ê¸°
  bm.backdrop.addEventListener("mousedown", (e)=>{
    if(e.target === bm.backdrop) closeBoardModal();
  });

  // ë“±ë¡ ë²„íŠ¼
  bm.submit.addEventListener("click", submitBoardPost);

  // Enterë¡œ ë“±ë¡(textarea ì œì™¸)
  [bm.nickname, bm.title].forEach(el=>{
    if(!el) return;
    el.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        submitBoardPost();
      }
    });
  });

  // ESCë¡œ ë‹«ê¸°
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && bm.backdrop.style.display === "block"){
      closeBoardModal();
    }
  });
}else{
  console.warn("ê²Œì‹œíŒ ëª¨ë‹¬ ìš”ì†Œ(id) ì¤‘ ì¼ë¶€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. HTML id í™•ì¸ í•„ìš”", bm);
}



// SIM/EDIT í† ê¸€
els.toggleMode.addEventListener("click", ()=>{
  if(state.viewerMode){
    // ê³µìœ ì: SIMë§Œ
    state.mode = "SIM";
  }else{
    state.mode = (state.mode === "SIM") ? "EDIT" : "SIM";
  }
  draw();
});

// ê´€ë¦¬ì EDIT(ë¹„ë²ˆ)
els.adminEdit.addEventListener("click", ()=>{
  if(state.adminUnlocked){
    // ì´ë¯¸ í’€ë ¸ìœ¼ë©´ í† ê¸€ë¡œ ë·°ì–´ëª¨ë“œ ë„ê¸°
    setViewerMode(false);
    state.mode = "EDIT";
    draw();
    return;
  }

  const inputRaw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if(inputRaw === null) return;
  const input = String(inputRaw).trim();

  if(input !== ADMIN_PASSWORD){
    alert("âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    return;
  }

  alert("âœ… ê´€ë¦¬ì ëª¨ë“œ í•´ì œ(EDIT ê°€ëŠ¥)");
  state.adminUnlocked = true;
  setViewerMode(false);
  state.mode = "EDIT";
  draw();
});

// SIM ë¹„ë²ˆ ì¬ì…ë ¥ ë²„íŠ¼
if(els.retrySimPwd){
  els.retrySimPwd.addEventListener("click", ()=>{
    askSimPassword();
  });
}

/** =========================
 *  ìš°ì¸¡ íŒ¨ë„(ë…¸ë“œ/ì—°ê²°/ë°°íƒ€)
 *  ========================= */

els.applyNode.addEventListener("click", ()=>{
  if(state.viewerMode) return;

  const n = state.nodes.find(x=>x.id===state.selected);
  if(!n) return alert("ì„ íƒëœ ë…¸ë“œê°€ ì—†ì–´!");

  const newId = String(els.nodeId.value || "").trim();
  const newMax = clamp(Number(els.nodeMax.value || 1), 1, 999);
  const newMode = (els.prereqMode && els.prereqMode.value) ? els.prereqMode.value : "ALL";

  // id ë³€ê²½ ì‹œ ì¶©ëŒ ì²´í¬
  if(newId && newId !== n.id){
    if(state.nodes.some(x=>x.id===newId)) return alert("ì´ë¯¸ ê°™ì€ IDê°€ ì¡´ì¬í•´!");
    // edges / lvl / parents / children / selected / exclusivesê¹Œì§€ ëª¨ë‘ ì¹˜í™˜
    const oldId = n.id;
    n.id = newId;

    state.edges = state.edges.map(([p,c])=>[
      p===oldId ? newId : p,
      c===oldId ? newId : c
    ]);

    // lvl key ë³€ê²½
    const oldVal = state.lvl[oldId] || 0;
    delete state.lvl[oldId];
    state.lvl[newId] = oldVal;

    // ì„ íƒ/ë¦¬ìŠ¤íŠ¸ ë³€ê²½
    if(state.selected === oldId) state.selected = newId;
    state.parents = state.parents.map(x=> x===oldId ? newId : x);
    state.children = state.children.map(x=> x===oldId ? newId : x);

    // ë°°íƒ€ ê·¸ë£¹ ë³€ê²½
    state.exclusives = (state.exclusives||[]).map(g=>{
      const parent = (g.parent===oldId) ? newId : g.parent;
      const group = Array.isArray(g.group) ? g.group.map(x=> x===oldId ? newId : x) : [];
      return { parent, group };
    });
  }

  n.max = newMax;
  n.prereqMode = newMode || "ALL";

  // max ì¤„ì—ˆìœ¼ë©´ í˜„ì¬ lvlì´ maxë³´ë‹¤ í´ ìˆ˜ ìˆìœ¼ë‹ˆ ë³´ì •
  state.lvl[n.id] = clamp(Number(state.lvl[n.id] || 0), 0, n.max);

  draw();
});

els.delNode.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  const id = state.selected;
  if(!id) return;

  if(!confirm(`${id} ë…¸ë“œë¥¼ ì‚­ì œí• ê¹Œ? (ì—°ê²°/ë°°íƒ€ë„ ê°™ì´ ì •ë¦¬ë¨)`)) return;

  state.nodes = state.nodes.filter(n=>n.id!==id);
  state.edges = state.edges.filter(([p,c])=>p!==id && c!==id);
  delete state.lvl[id];

  // ë°°íƒ€ ê·¸ë£¹ì—ì„œë„ ì œê±°
  state.exclusives = (state.exclusives||[])
    .map(g=>({ parent:g.parent, group:(g.group||[]).filter(x=>x!==id) }))
    .filter(g => g.parent !== id && (g.group||[]).length);

  state.parents = state.parents.filter(x=>x!==id);
  state.children = state.children.filter(x=>x!==id);
  state.selected = null;

  draw();
});

// ë¶€ëª¨/ìì‹ ëª©ë¡ í† ê¸€
els.setParent.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  if(!state.selected) return alert("ë…¸ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜!");
  toggleIn(state.parents, state.selected);
  draw();
});
els.setChild.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  if(!state.selected) return alert("ë…¸ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì¤˜!");
  toggleIn(state.children, state.selected);
  draw();
});

els.clearParent.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  state.parents = [];
  draw();
});
els.clearChild.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  state.children = [];
  draw();
});

// ì—°ê²° ì¶”ê°€/ì œê±°(ë¶€ëª¨ëª©ë¡Ã—ìì‹ëª©ë¡)
els.addEdge.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  if(!state.parents.length || !state.children.length) return alert("ë¶€ëª¨/ìì‹ ëª©ë¡ì„ ë¨¼ì € ì±„ì›Œì¤˜!");

  for(const p of state.parents){
    for(const c of state.children){
      if(p === c) continue;
      if(!state.edges.some(([pp,cc])=>pp===p && cc===c)){
        state.edges.push([p,c]);
      }
    }
  }
  draw();
});

els.removeEdge.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  if(!state.parents.length || !state.children.length) return alert("ë¶€ëª¨/ìì‹ ëª©ë¡ì„ ë¨¼ì € ì±„ì›Œì¤˜!");

  state.edges = state.edges.filter(([p,c])=>{
    const pHit = state.parents.includes(p);
    const cHit = state.children.includes(c);
    return !(pHit && cHit);
  });

  // ì—°ê²° ì œê±°ë˜ë©´ ë°°íƒ€ ê·¸ë£¹ë„ ì˜ë¯¸ì—†ì„ ìˆ˜ ìˆì–´ì„œ ì•ˆì „ ì •ë¦¬
  const edgeSet = new Set(state.edges.map(([p,c])=>`${p}=>${c}`));
  state.exclusives = (state.exclusives||[])
    .map(g=>{
      const parent = g.parent;
      const group = (g.group||[]).filter(ch => edgeSet.has(`${parent}=>${ch}`));
      return { parent, group };
    })
    .filter(g => (g.group||[]).length);

  draw();
});

// âœ… ë°°íƒ€(íƒ1) ì„¤ì •
els.setExclusive.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  if(!state.parents.length || !state.children.length) return alert("ë¶€ëª¨/ìì‹ ëª©ë¡ì„ ë¨¼ì € ì±„ì›Œì¤˜!");

  // ë¶€ëª¨ëª©ë¡Ã—ìì‹ëª©ë¡ì„ â€œë¶€ëª¨ë³„ ê·¸ë£¹â€ìœ¼ë¡œ ë¬¶ì–´ì„œ ë“±ë¡
  for(const p of state.parents){
    const groupChildren = state.children.filter(c=>c!==p);

    // ì—°ê²°ì´ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ ë°°íƒ€ë¡œ ë„£ê¸°
    const validChildren = groupChildren.filter(c => state.edges.some(([pp,cc])=>pp===p && cc===c));
    if(!validChildren.length) continue;

    let g = state.exclusives.find(x=>x.parent===p);
    if(!g){
      g = { parent:p, group:[] };
      state.exclusives.push(g);
    }
    for(const c of validChildren){
      if(!g.group.includes(c)) g.group.push(c);
    }
  }
  draw();
});

els.clearExclusive.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  if(!confirm("ë°°íƒ€(íƒ1) ê·¸ë£¹ì„ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
  state.exclusives = [];
  draw();
});

// JSON ë³µì‚¬/ë¶ˆëŸ¬ì˜¤ê¸°
els.copyJson.addEventListener("click", async ()=>{
  const text = els.json.value || "";
  try{
    await navigator.clipboard.writeText(text);
    alert("âœ… JSON ë³µì‚¬ ì™„ë£Œ!");
  }catch(e){
    alert("ë³µì‚¬ ì‹¤íŒ¨! ì§ì ‘ ë“œë˜ê·¸í•´ì„œ ë³µì‚¬í•´ì¤˜.");
  }
});

els.loadJson.addEventListener("click", ()=>{
  if(state.viewerMode) return;
  try{
    const obj = JSON.parse(els.json.value || "{}");
    applyPack(obj);
    draw();
  }catch(e){
    alert("âŒ JSON íŒŒì‹± ì‹¤íŒ¨! í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì¤˜.");
  }
});

/** =========================
 *  ì‹œì‘ ì‹œ: í•´ì‹œ ë¡œë“œ & ê³µìœ ëª¨ë“œ íŒë³„
 *  ========================= */

(function init(){
    // âœ… ?id=xxxx ë¡œ ë“¤ì–´ì˜¨ ê²½ìš°: DBì—ì„œ ë¡œë“œ(ì§§ì€ ë§í¬)
  const params = new URLSearchParams(location.search);
  const shareId = params.get("id");

  if(shareId){
    loadFromDB(shareId)
      .then(payload=>{
        applyPack(payload);
        setViewerMode(true);

        // ê³µìœ  SIMì€ ê¸°ë³¸ ì ê¸ˆ
        if(!state.simUnlockedOnce) setSimLocked(true);

        resize();
        draw();
      })
      .catch(err=>{
        console.error(err);
        alert("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ê³µìœ  ë§í¬ì…ë‹ˆë‹¤.");
      });

    return; // ì—¬ê¸°ì„œ ì¢…ë£Œ (hash ë¡œì§ ì•ˆíƒ)
  }

  // í•´ì‹œ ìˆìœ¼ë©´ ë¡œë“œ
  const has = loadFromHash();

  // í•´ì‹œë¡œ ë“¤ì–´ì˜¨ ê²½ìš° = ê³µìœ  ë§í¬ì¼ ê°€ëŠ¥ì„± ë†’ìŒ â†’ ë·°ì–´ëª¨ë“œ ON
  if(has){
    setViewerMode(true);

    // ê³µìœ  SIMì€ ê¸°ë³¸ ì ê¸ˆ
    if(!state.simUnlockedOnce){
      setSimLocked(true);
    }
  }else{
    // ê¸°ë³¸ì€ í¸ì§‘ì
    setViewerMode(false);
  }

  // ì´ˆê¸° ë³´ìœ ê°’ ë°˜ì˜
  state.owned = clamp(Number(els.ownedSp.value || 0), 0, state.seasonMax);
  els.ownedSp.value = String(state.owned);

  // ìµœì´ˆ ë Œë”
  resize();
  draw();

  // ê³µìœ ìë©´ ì²˜ìŒ í•œë²ˆ ë¹„ë²ˆ ìš”ì²­(ìë™ íŒì—… ì›í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ)
  if(state.viewerMode){ askSimPassword(); }

})();
</script>
</body>
</html>




































