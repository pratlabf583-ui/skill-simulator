<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>전승 트리 게시판 - 강모찌 시뮬레이터</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --text:#e8eefc;
      --muted:#9bb0d0; --line:#23324a; --danger:#ff4d4d;
      --ok:#7CFF6B; --accent:#78b9ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
    }
    .top{
      display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;
      justify-content:space-between;margin-bottom:12px;
    }
    .kpi{font-size:18px;font-weight:900}
    .muted{color:var(--muted);font-size:13px;white-space:pre-wrap}
    button,input,select{
      background:#0f1624;color:var(--text);
      border:1px solid var(--line);border-radius:10px;padding:8px 12px;
    }
    button:hover{border-color:#3a527a;cursor:pointer;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--line);
      background:#0f1624;color:var(--muted);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
    }
    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .item{
      display:flex;gap:12px;align-items:flex-start;
      padding:12px;border:1px solid var(--line);border-radius:14px;
      background:#0f1624;
    }
    .item:hover{border-color:#3a527a}
    .itemMain{flex:1;min-width:0}
    .title{
      font-weight:900;font-size:16px;line-height:1.25;
      word-break:break-word;
    }
    .meta{
      margin-top:6px;
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      color:var(--muted);font-size:12px;
    }
    .desc{
      margin-top:8px;color:var(--text);opacity:.92;
      font-size:13px;line-height:1.45;word-break:break-word;
    }
    .right{
      display:flex;flex-direction:column;gap:8px;align-items:flex-end;
      min-width:120px;
    }
    .badge{
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.ok{color:var(--ok);border-color:rgba(124,255,107,0.35)}
    .badge.accent{color:var(--accent);border-color:rgba(120,185,255,0.35)}
    .btnLink{
      display:inline-flex;align-items:center;justify-content:center;
      text-decoration:none;
      background:#0f1624;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 12px;
      white-space:nowrap;
    }
    .btnLink:hover{border-color:#3a527a}
    .hr{border-top:1px solid var(--line);margin:12px 0}
    .empty{
      text-align:center;padding:24px;color:var(--muted);
      border:1px dashed var(--line);border-radius:14px;
    }
    @media (max-width: 640px){
      .right{align-items:flex-start;min-width:auto}
      .item{flex-direction:column}
    }
   /* ✅ 전체 배경 이미지 */
/* ✅ 전체 배경 이미지 (CSS 변수로 관리) */
:root{
  --bgImage: url("https://github.com/pratlabf583-ui/skill-simulator/blob/main/lee.jpg?raw=true");
  --bgX: 50%;
  --bgY: 50%;
  --bgZoom: 1;
}

body{
  background-image: var(--bgImage);
  background-size: calc(100% * var(--bgZoom)) calc(100% * var(--bgZoom));
  background-position: var(--bgX) var(--bgY);
  background-attachment: fixed;
  background-repeat: no-repeat;
}




/* ✅ 위에 올라가는 카드/박스는 살짝 반투명 */
.card{
  background: rgba(18,26,39,0.88);
  backdrop-filter: blur(6px);
}
 
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="card" style="flex:1;min-width:280px">
      <div class="kpi">전승 트리 게시판</div>
      <div class="muted" id="sub">
- 최신 등록된 트리들을 보여줍니다.
- 글 클릭 → 해당 트리 공유 링크로 이동합니다.
      </div>
      <div class="row" style="margin-top:10px">
        <a class="btnLink" id="goSim" href="./" title="시뮬레이터로 이동">시뮬레이터로</a>
        <span class="pill" id="countPill">로딩중…</span>
      </div>
    </div>

    <div class="card" style="min-width:280px;flex:1">
      <div class="kpi">검색/필터</div>
      <div class="row" style="margin-top:10px">
        <input id="q" placeholder="닉네임/제목/직업/설명 검색" style="flex:1;min-width:220px">
      </div>
      <div class="row" style="margin-top:10px">
        <select id="jobFilter" style="flex:1;min-width:220px">
          <option value="">직업 전체</option>
        </select>
        <button id="reload">새로고침</button>
      </div>
      <div class="muted" id="status" style="margin-top:8px"></div>
      
<div class="muted small" style="margin-top:6px">
  ※ 이 설정은 이 브라우저에만 저장됩니다.
</div>

    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="kpi" style="font-size:16px">목록</div>
        <div class="muted">최신순</div>
      </div>
      <div class="hr"></div>
      <div class="list" id="list"></div>
      <div class="empty" id="empty" style="display:none">아직 게시글이 없습니다.</div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
  /** =========================
   * ✅ Supabase 설정 (시뮬레이터와 동일)
   * ========================= */
  const SUPABASE_URL = "https://ytzggylozlcgcaoaupwo.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_rZtoLYXkC53jwHycEzC2ZQ_RW82bspa";
  const SB = window.supabase;

  if (!SB || typeof SB.createClient !== "function") {
    alert("Supabase 라이브러리 로드 실패(차단/오프라인). Ctrl+F5 해보고, 애드블록/보안프로그램 확인!");
    throw new Error("Supabase SDK not loaded");
  }

  const sbClient = SB.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const els = {
    list: document.getElementById("list"),
    empty: document.getElementById("empty"),
    q: document.getElementById("q"),
    jobFilter: document.getElementById("jobFilter"),
    reload: document.getElementById("reload"),
    status: document.getElementById("status"),
    countPill: document.getElementById("countPill"),
    goSim: document.getElementById("goSim"),
  };

  // 현재 board.html이 있는 폴더 기준으로 시뮬레이터 주소 맞추기
  // (루트에 board.html 두면 "./" 가 index.html로 감)
  els.goSim.href = "./";

  let allPosts = [];     // 전체 posts
  let viewPosts = [];    // 필터된 posts

  function fmtTime(iso){
    try{
      const d = new Date(iso);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yy}-${mm}-${dd} ${hh}:${mi}`;
    }catch(e){
      return iso || "";
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function buildShareUrl(shareId){
    // 시뮬레이터 페이지가 같은 폴더/루트라고 가정:
    // index.html?id=xxxxx 형태로 이동
    const base = location.origin + location.pathname.replace(/board\.html$/i, "");
    return base + "?id=" + encodeURIComponent(shareId);
  }

  function render(){
    const list = els.list;
    list.innerHTML = "";

    if(!viewPosts.length){
      els.empty.style.display = "block";
      els.countPill.textContent = "0개";
      return;
    }
    els.empty.style.display = "none";
    els.countPill.textContent = `${viewPosts.length}개`;

    for(const p of viewPosts){
      const shareUrl = buildShareUrl(p.share_id);
      const nickname = escapeHtml(p.nickname);
      const title = escapeHtml(p.title);
      const job = escapeHtml(p.job);
      const desc = escapeHtml(p.desc || "");
      const sp = Number(p.sp ?? 0);
      const time = fmtTime(p.created_at);

      const el = document.createElement("a");
      el.className = "item";
      el.href = shareUrl;
      el.target = "_blank";
      el.rel = "noopener noreferrer";
      el.style.textDecoration = "none";

      el.innerHTML = `
        <div class="itemMain">
          <div class="title">${title}</div>
          <div class="meta">
            <span class="badge accent">직업: ${job || "-"}</span>
            <span class="badge">닉네임: ${nickname || "-"}</span>
            <span class="badge">등록: ${escapeHtml(time)}</span>
          </div>
          ${desc ? `<div class="desc">${desc}</div>` : ""}
        </div>
        <div class="right">
          <span class="badge ok">포인트: ${sp}</span>
          <span class="btnLink">트리 열기</span>
        </div>
      `;
      list.appendChild(el);
    }
  }

  function applyFilter(){
    const q = (els.q.value || "").trim().toLowerCase();
    const jf = (els.jobFilter.value || "").trim().toLowerCase();

    viewPosts = allPosts.filter(p=>{
      const job = String(p.job || "").toLowerCase();
      const hay = [
        p.nickname, p.title, p.job, p.desc
      ].map(x=>String(x||"").toLowerCase()).join(" ");

      if(jf && job !== jf) return false;
      if(q && !hay.includes(q)) return false;
      return true;
    });

    render();
  }

  function fillJobFilter(){
    const set = new Set();
    for(const p of allPosts){
      const j = String(p.job || "").trim();
      if(j) set.add(j);
    }
    const jobs = [...set].sort((a,b)=>a.localeCompare(b,"ko"));

    // 기존 옵션 초기화 (첫번째 "전체" 유지)
    els.jobFilter.innerHTML = `<option value="">직업 전체</option>`;
    for(const j of jobs){
      const opt = document.createElement("option");
      opt.value = j;
      opt.textContent = j;
      els.jobFilter.appendChild(opt);
    }
  }

  async function loadPosts(){
    els.status.textContent = "불러오는 중…";
    els.status.style.color = "#9bb0d0";

    try{
      // posts 테이블에서 최신순으로 200개까지
      const { data, error } = await sbClient
        .from("posts")
        .select("id, created_at, nickname, title, job, sp, desc, share_id")
        .order("created_at", { ascending: false })
        .limit(200);

      if(error) throw error;

      allPosts = Array.isArray(data) ? data : [];
      fillJobFilter();
      applyFilter();

      els.status.textContent = allPosts.length
        ? `✅ 로드 완료 (${allPosts.length}개)`
        : "ℹ️ 게시글이 아직 없습니다.";
      els.status.style.color = "#9bb0d0";
    }catch(e){
      console.error(e);
      els.status.textContent = "❌ 로드 실패! (Supabase RLS/테이블/키 확인)";
      els.status.style.color = "#ff6b6b";
      allPosts = [];
      viewPosts = [];
      render();
    }
  }

  // 이벤트
  els.q.addEventListener("input", applyFilter);
  els.jobFilter.addEventListener("change", applyFilter);
  els.reload.addEventListener("click", loadPosts);

  // 시작
  loadPosts();
  // ✅ 관리자 배경(전원 공통) 불러오기: site_config.key = 'board_bg'
async function loadAdminBackground(){
  const DEFAULT = {
    url: "https://github.com/pratlabf583-ui/skill-simulator/blob/main/lee.jpg?raw=true",
    x: "50%",
    y: "50%",
    zoom: 1
  };

  try{
    const { data, error } = await sbClient
      .from("site_config")
      .select("value")
      .eq("key", "board_bg")
      .maybeSingle();

    if(error) throw error;

    const v = (data && data.value) ? data.value : DEFAULT;

    const url = (v.url || DEFAULT.url).trim();
    const x = (v.x || DEFAULT.x);
    const y = (v.y || DEFAULT.y);
    const zoom = Number(v.zoom ?? DEFAULT.zoom);

    document.documentElement.style.setProperty("--bgImage", `url("${url}")`);
    document.documentElement.style.setProperty("--bgX", x);
    document.documentElement.style.setProperty("--bgY", y);
    document.documentElement.style.setProperty("--bgZoom", String(Number.isFinite(zoom) ? zoom : 1));
  }catch(e){
    console.error("admin bg load fail:", e);
    // 실패하면 CSS 기본값 그대로 사용
  }
}

// 시작
loadPosts();
loadAdminBackground();

    /** =========================
   * ✅ 배경 이미지 URL localStorage 저장/불러오기
   * (board.html 전용)
   * ========================= */
  (function bgLocalStorageInit(){
    const KEY = "board_bg_url"; // 저장 키(이름)
    const DEFAULT_BG = "https://github.com/pratlabf583-ui/skill-simulator/blob/main/lee.jpg?raw=true";

    // 저장된 값 있으면 적용, 없으면 기본값
    const saved = localStorage.getItem(KEY);
    const url = (saved && saved.trim()) ? saved.trim() : DEFAULT_BG;

    // CSS 변수로 배경 적용
    document.documentElement.style.setProperty("--bgImage", `url("${url}")`);

    // (선택) 입력칸/버튼이 있을 때만 동작
    const input = document.getElementById("bgUrlInput");
    const applyBtn = document.getElementById("bgApply");
    const resetBtn = document.getElementById("bgReset");

    if(input) input.value = url;

    if(applyBtn && input){
      applyBtn.addEventListener("click", ()=>{
        const v = (input.value || "").trim();
        if(!v){
          alert("이미지 URL을 입력해줘!");
          return;
        }
        localStorage.setItem(KEY, v);
        document.documentElement.style.setProperty("--bgImage", `url("${v}")`);
        alert("✅ 배경 저장 완료! 다음에 들어와도 유지돼.");
      });
    }

    if(resetBtn){
      resetBtn.addEventListener("click", ()=>{
        localStorage.removeItem(KEY);
        document.documentElement.style.setProperty("--bgImage", `url("${DEFAULT_BG}")`);
        if(input) input.value = DEFAULT_BG;
        alert("✅ 기본 배경으로 복구했어.");
      });
    }
        // ✅ 배경 위치/줌 저장 키
    const POS_KEY = "board_bg_pos";
    const ZOOM_KEY = "board_bg_zoom";

    // ✅ 저장된 위치/줌 불러오기
    const savedPos = localStorage.getItem(POS_KEY);
    const savedZoom = localStorage.getItem(ZOOM_KEY);

    if(savedZoom){
      const z = Number(savedZoom);
      if(!Number.isNaN(z)) document.documentElement.style.setProperty("--bgZoom", String(z));
    }
    if(savedPos){
      try{
        const obj = JSON.parse(savedPos);
        if(obj && obj.x != null && obj.y != null){
          document.documentElement.style.setProperty("--bgX", obj.x);
          document.documentElement.style.setProperty("--bgY", obj.y);
        }
      }catch(e){}
    }

    // ✅ 드래그로 배경 위치 이동
    let dragging = false;
    let startX = 0, startY = 0;
    let curX = getComputedStyle(document.documentElement).getPropertyValue("--bgX").trim() || "50%";
    let curY = getComputedStyle(document.documentElement).getPropertyValue("--bgY").trim() || "50%";

    // 현재값을 px로 만들기 (퍼센트면 0으로 시작)
    function toPx(v){
      v = String(v).trim();
      if(v.endsWith("px")) return parseFloat(v) || 0;
      return 0; // %면 드래그 시작시 0으로 두고 px로 전환
    }

    let baseX = toPx(curX);
    let baseY = toPx(curY);

    function savePos(x, y){
      localStorage.setItem(POS_KEY, JSON.stringify({ x: `${x}px`, y: `${y}px` }));
    }
    function saveZoom(z){
      localStorage.setItem(ZOOM_KEY, String(z));
    }

    // 드래그는 "빈 배경"에서만 하고 싶으면 body에 걸면 됨
    // 카드에서 드래그하면 스크롤/텍스트 선택이 방해될 수 있어서,
    // Alt키 누르고 드래그할 때만 작동하게 함.
    document.addEventListener("mousedown", (e)=>{
  if(!e.altKey) return;

  dragging = true;
  startX = e.clientX;
  startY = e.clientY;

  // 드래그 시작 순간 현재 값을 기준으로
  const sx = getComputedStyle(document.documentElement).getPropertyValue("--bgX").trim();
  const sy = getComputedStyle(document.documentElement).getPropertyValue("--bgY").trim();

  // ✅ %면 화면 중심을 px로 계산해서 시작(점프 방지)
  if(sx.endsWith("%")){
    baseX = (window.innerWidth * (parseFloat(sx) / 100)) || 0;
  }else{
    baseX = toPx(sx);
  }

  if(sy.endsWith("%")){
    baseY = (window.innerHeight * (parseFloat(sy) / 100)) || 0;
  }else{
    baseY = toPx(sy);
  }

  e.preventDefault();
});


    document.addEventListener("mousemove", (e)=>{
      if(!dragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      const nx = baseX + dx;
      const ny = baseY + dy;

      document.documentElement.style.setProperty("--bgX", `${nx}px`);
      document.documentElement.style.setProperty("--bgY", `${ny}px`);
      savePos(nx, ny);
    });

    document.addEventListener("mouseup", ()=>{
      dragging = false;
    });

    // ✅ 휠로 배경 확대/축소 (Alt + 휠)
    document.addEventListener("wheel", (e)=>{
      if(!e.altKey) return; // ✅ Alt + 휠일 때만
      e.preventDefault();

      const cur = Number(getComputedStyle(document.documentElement).getPropertyValue("--bgZoom")) || 1;
      const delta = -Math.sign(e.deltaY);
      const next = Math.min(3, Math.max(0.5, cur + delta * 0.08)); // 0.5x ~ 3x
      document.documentElement.style.setProperty("--bgZoom", String(next));
      saveZoom(next);
    }, { passive:false });

  })();

</script>
</body>
</html>






